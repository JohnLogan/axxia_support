From 44cba1d54725a0eaaa3ada8e365a3b101d815342 Mon Sep 17 00:00:00 2001
From: John Jacques <john.jacques@intel.com>
Date: Wed, 7 Dec 2016 12:53:39 -0600
Subject: [PATCH 1/4] datalogger: GIC Driver Changes for the Axxia Test Case

Signed-off-by: John Jacques <john.jacques@intel.com>
---
 drivers/irqchip/irq-gic-v3.c | 23 +++++++++++++++++++++++
 1 file changed, 23 insertions(+)

diff --git a/drivers/irqchip/irq-gic-v3.c b/drivers/irqchip/irq-gic-v3.c
index f1b15a0..a4c6cf9 100644
--- a/drivers/irqchip/irq-gic-v3.c
+++ b/drivers/irqchip/irq-gic-v3.c
@@ -388,6 +388,18 @@ static void __init gic_dist_init(void)
 	for (i = 32; i < gic_data.irq_nr; i += 32)
 		writel_relaxed(~0, base + GICD_IGROUPR + i / 8);
 
+#ifdef CONFIG_ARCH_AXXIA
+	/*
+	 * Part of an example of creating a crash log in memory on Axxia...
+	 *
+	 * Set the interrupt generated by timer 7 to secure group 0.  This
+	 * allows the secure monitor to handle this interrupt as an FIQ and
+	 * create the crash log in memory before the watchdog fires.
+	 */
+
+        writel_relaxed(0xffffffef, base + GICD_IGROUPR + 8);
+#endif
+
 	gic_dist_config(base, gic_data.irq_nr, gic_dist_wait_for_rwp);
 
 	/* Enable distributor with ARE, Group1 */
@@ -491,8 +503,19 @@ static void gic_cpu_init(void)
 
 	rbase = gic_data_rdist_sgi_base();
 
+#ifdef CONFIG_ARCH_AXXIA
+	/*
+	 * Part of an example of creating a crash log in memory on Axxia...
+	 *
+	 * Configure all PPIs and SGIs used by Linux as non-secure
+	 * group 1, others are secure group 0.
+	 */
+	writel_relaxed((0xffff0000 | ((1 << NR_IPI) - 1)),
+		       rbase + GICR_IGROUPR0);
+#else
 	/* Configure SGIs/PPIs as non-secure Group-1 */
 	writel_relaxed(~0, rbase + GICR_IGROUPR0);
+#endif
 
 	gic_cpu_config(rbase, gic_redist_wait_for_rwp);
 
-- 
2.5.2

